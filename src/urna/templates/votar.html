{% extends '_partials/base.html' %}
{% load static %}
{% block title %} - Voto{% endblock %}
{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/index.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-4">
    {% if voting_complete %}
        <div class="alert alert-success text-center" role="alert">
            <h2>‚úÖ Vota√ß√£o Conclu√≠da!</h2>
            <p>Voc√™ votou em todos os cargos da elei√ß√£o <strong>{{ eleicao.nome }}</strong>.</p>
            <a href="{% url 'index' %}" class="btn btn-primary mt-3">Voltar para In√≠cio</a>
        </div>
    {% else %}
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h2 class="mb-0 text-center">üó≥Ô∏è Vota√ß√£o: {{ eleicao.nome }}</h2>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h4 class="text-center">Cargo: <strong>{{ cargo.nome }}</strong></h4>
                    <p class="text-center text-muted">
                        Progresso: {{ request.session.cargos_votados|default:0 }} de {{ total_cargos }} cargo(s) votado(s)
                    </p>
                </div>

                <form method="POST" action="{% url 'votar' eleicao.pk %}">
                    {% csrf_token %}

                    {# Hidden fields for the form #}
                    <input type="hidden" name="eleicao" value="{{ eleicao.pk }}">
                    <input type="hidden" name="cargo" value="{{ cargo.pk }}">
                    <input type="hidden" name="eleitor" value="{{ request.user.eleitor.pk }}">

                    <div class="mb-4">
                        <h5 class="mb-3">Digite o n√∫mero do candidato:</h5>

                        {% if cargo.candidatos.all %}
                            {% comment %}{% for candidato in cargo.candidatos.all %}
                                <div class="form-check mb-2 p-3 border rounded {% if forloop.counter0|divisibleby:2 %}bg-light{% endif %}">
                                    <input class="form-check-input"
                                           type="radio"
                                           name="candidato"
                                           id="candidato_{{ candidato.pk }}"
                                           value="{{ candidato.pk }}"
                                           required>
                                    <label class="form-check-label w-100" for="candidato_{{ candidato.pk }}">
                                        <strong>{{ candidato.numero }}</strong> - {{ candidato.eleitor.user.get_full_name|default:candidato.eleitor.user.username }}
                                        {% if candidato.partido %}
                                            <span class="badge bg-secondary">{{ candidato.partido }}</span>
                                        {% endif %}
                                    </label>
                                </div>
                            {% endfor %}{% endcomment %}

                            {# Option for blank/null vote #}
                            {% comment %}<div class="form-check mb-2 p-3 border rounded">
                                <input class="form-check-input"
                                       type="radio"
                                       name="candidato"
                                       id="candidato_nulo"
                                       value=""
                                       required>
                                <label class="form-check-label w-100" for="candidato_nulo">
                                    <strong>VOTO NULO</strong> - N√£o votar em nenhum candidato
                                </label>
                            </div>{% endcomment %}
                            <div class="mb-3">
                            <label for="numero_candidato" class="form-label">N√∫mero do Candidato</label>
                            <input type="text"
                                   class="form-control form-control-lg text-center"
                                   id="numero_candidato"
                                   name="numero_candidato"
                                   placeholder="N√∫mero do Candidato com {{ cargo.digitos }} d√≠gitos"
                                   maxlength="{{ cargo.digitos }}"
                                   style="font-size: 2rem; letter-spacing: 0.5rem;">
                            <div class="form-text text-center mt-2">
                                Digite o n√∫mero do candidato ou clique em "Voto em Branco"
                            </div>

                            <!-- Candidate Preview Area -->
                            <div id="candidato-preview" class="mt-4 p-3 border rounded text-center" style="display: none;">
                                <div id="preview-loading" style="display: none;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Carregando...</span>
                                    </div>
                                </div>
                                <div id="preview-content" style="display: none;">
                                    <img id="preview-foto" 
                                        src="" 
                                        alt="Foto do candidato" 
                                        class="mb-3 mx-auto" 
                                        style="max-width: 300px; max-height: 200px;">
                                    <h5 id="preview-nome"></h5>
                                    <p class="text-muted mb-1">
                                        <strong>N√∫mero:</strong> <span id="preview-numero"></span>
                                    </p>
                                    <p class="text-muted" id="preview-partido-container" style="display: none;">
                                        <strong>Partido:</strong> <span id="preview-partido"></span>
                                    </p>
                                </div>
                                <div id="preview-not-found" style="display: none;">
                                    <p class="text-danger">‚ùå Candidato n√£o encontrado</p>
                                </div>
                            </div>
                        </div>

                        {% else %}
                            <div class="alert alert-warning">
                                N√£o h√° candidatos cadastrados para este cargo.
                            </div>
                        {% endif %}
                    </div>

                    {% if form.errors %}
                        <div class="alert alert-danger">
                            <strong>Erro ao processar o voto:</strong>
                            {{ form.errors }}
                        </div>
                    {% endif %}

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-lg" name="action" value="votar">
                            {% if request.session.cargos_votados|default:0|add:1 >= total_cargos %}
                                Confirmar Voto e Finalizar
                            {% else %}
                                Confirmar Voto
                            {% endif %}
                        </button>
                        <button type="submit" class="btn btn-warning btn-lg" name="action" value="branco">
                            Voto em Branco
                        </button>
                        <a href="{% url 'index' %}" class="btn btn-outline-secondary">Cancelar</a>
                        <a href="{% url 'candidatos' eleicao.pk %}" class="btn btn-outline-secondary">Ver Candidatos</a>
                    </div>
                </form>
            </div>
        </div>
    {% endif %}
</div>
// Preview do candidato sendo digitado no momento
<script>
    let searchTimeout;
    const numeroInput = document.getElementById('numero_candidato');
    const previewContainer = document.getElementById('candidato-preview');
    const previewLoading = document.getElementById('preview-loading');
    const previewContent = document.getElementById('preview-content');
    const previewNotFound = document.getElementById('preview-not-found');

    numeroInput.addEventListener('input', function(e) {
        const numero = e.target.value.trim();

        clearTimeout(searchTimeout);

        previewContainer.style.display = 'none';
        previewLoading.style.display = 'none';
        previewContent.style.display = 'none';
        previewNotFound.style.display = 'none';

        if (numero.length === {{ cargo.digitos }}) {
            previewContainer.style.display = 'block';
            previewLoading.style.display = 'block';

            searchTimeout = setTimeout(() => {
                buscarCandidato(numero);
            }, 300);
        }
    });

    async function buscarCandidato(numero) {
        try {
            const buscarCandidatoBaseUrl = "{% url 'buscar_candidato' eleicao.pk cargo.pk 0 %}".replace('/0', '');
            const response = await fetch(
                `${buscarCandidatoBaseUrl}/${numero}`
            );
            const data = await response.json();

            previewLoading.style.display = 'none';

            if (data.candidato) {
                // Update preview with candidate data
                document.getElementById('preview-nome').textContent = data.nome;
                document.getElementById('preview-numero').textContent = data.numero;

                if (data.foto_url) {
                    document.getElementById('preview-foto').src = data.foto_url;
                    document.getElementById('preview-foto').style.display = 'block';
                } else {
                    document.getElementById('preview-foto').style.display = 'none';
                }

                if (data.partido) {
                    document.getElementById('preview-partido').textContent = data.partido;
                    document.getElementById('preview-partido-container').style.display = 'block';
                } else {
                    document.getElementById('preview-partido-container').style.display = 'none';
                }

                previewContent.style.display = 'block';
            } else {
                previewNotFound.style.display = 'block';
            }
        } catch (error) {
            console.error('Erro ao buscar candidato:', error);
            previewLoading.style.display = 'none';
            previewNotFound.style.display = 'block';
        }
    }
</script>
{% endblock %}